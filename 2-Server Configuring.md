<div dir="rtl">

# پیکربندی Keycloak

Configure and start Keycloak.
این راهنما روش‌های پیکربندی Keycloak و نحوه‌ی شروع و اعمال پیکربندیِ ترجیحی را توضیح می‌دهد. همچنین شامل دستورالعمل‌های پیکربندی برای بهینه‌سازی Keycloak جهت راه‌اندازی سریع‌تر و ردپای حافظه‌ی کم است.

---

## منابع پیکربندی برای Keycloak

Keycloak پیکربندی را از چهار منبع بارگذاری می‌کند که در اینجا به ترتیب اعمال‌شدن فهرست شده‌اند.

* پارامترهای خط فرمان (Command-line parameters)

* متغیرهای محیطی (Environment variables)

* گزینه‌های تعریف‌شده در فایل `conf/keycloak.conf` یا در یک فایل پیکربندی ساخته‌شده توسط کاربر.

* گزینه‌های حساس که در یک فایل Java KeyStore ساخته‌شده توسط کاربر تعریف شده‌اند.

وقتی گزینه‌ای در بیش از یک منبع تنظیم شده باشد، موردی که زودتر در فهرست آمده، مقدار آن گزینه را تعیین می‌کند.
برای مثال، مقدار یک گزینه که با پارامتر خط فرمان تنظیم شده باشد، نسبت به متغیر محیطیِ همان گزینه، اولویت بیشتری دارد.

---

### مثال: پیکربندی پارامتر `db-url-host`

مثال زیر نشان می‌دهد چگونه مقدار `db-url` در چهار منبع پیکربندی تنظیم می‌شود:

منبع — فرمت
پارامترهای خط فرمان
`--db-url=cliValue`

متغیر محیطی
`KC_DB_URL=envVarValue`

فایل پیکربندی
`db-url=confFileValue`

فایل Java KeyStore
`kc.db-url=keystoreValue`

بر اساس اولویت اعمال، مقداری که در زمان راه‌اندازی استفاده می‌شود `cliValue` است، چون خط فرمان بالاترین اولویت را دارد.

اگر `--db-url=cliValue` استفاده نشده بود، مقدار اعمال‌شده `KC_DB_URL=envVarValue` می‌بود. اگر مقدار نه از خط فرمان و نه از متغیر محیطی اعمال نشده بود، `db-url=confFileValue` استفاده می‌شد. اگر هیچ‌یک از مقادیر قبلی اعمال نشده بود، مقدار `kc.db-url=keystoreValue` به‌علت پایین‌ترین اولویت در بین منابع موجود استفاده می‌شد.

---

## قالب‌ها برای پیکربندی

پیکربندی از یک فرمتِ یکپارچه-برای-هر-منبع استفاده می‌کند که ترجمه‌ی یک جفت کلید/مقدار از یک منبع پیکربندی به منبع دیگر را ساده می‌کند. توجه داشته باشید این قالب‌ها برای گزینه‌های SPI نیز اعمال می‌شوند.

### قالب پارامتر خط فرمان (Command-line parameter format)

مقادیر برای خط فرمان از فرمت `--<key-with-dashes>=<value>` استفاده می‌کنند. برای برخی مقادیر، مخفف `-<abbreviation>=<value>` نیز وجود دارد.

### قالب متغیر محیطی (Environment variable format)

مقادیر برای متغیرهای محیطی از فرمت بزرگ‌نویسی‌شده‌ی `KC_<key_with_underscores>=<value>` استفاده می‌کنند.

### قالب فایل پیکربندی (Configuration file format)

مقادیرِ واردشده در فایل پیکربندی از فرمت `<key-with-dashes>=<value>` استفاده می‌کنند.

### قالب فایل پیکربندی Keystore (KeyStore configuration file format)

مقادیرِ واردشده در فایل پیکربندی Keystore از فرمت `kc.<key-with-dashes>` استفاده می‌کنند. `<value>` سپس یک گذرواژه است که در Keystore ذخیره می‌شود.

در انتهای هر راهنمای پیکربندی، به بخش «Relevant options» نگاه کنید که قالب‌های پیکربندیِ قابل‌اعمال را تعریف می‌کند. برای تمام گزینه‌های پیکربندی، به «All configuration» مراجعه کنید. منبع و فرمت پیکربندی‌ای را انتخاب کنید که برای مورد استفاده‌ی شما قابل‌اعمال است.

---

### مثال – قالب‌های جایگزین بر اساس منبع پیکربندی

مثال زیر قالب پیکربندی برای `db-url-host` را برای سه منبع پیکربندی نشان می‌دهد:

پارامتر خط فرمان
`bin/kc.[sh|bat] start --db-url-host=mykeycloakdb`

متغیر محیطی
`export KC_DB_URL_HOST=mykeycloakdb`

conf/keycloak.conf
`db-url-host=mykeycloakdb`

---

## قالب‌ها برای پارامترهای خط فرمان (Formats for command-line parameters)

Keycloak همراه با پارامترهای زیاد خط فرمان برای پیکربندی عرضه می‌شود. برای دیدن قالب‌های پیکربندی موجود، دستور زیر را وارد کنید:

`bin/kc.[sh|bat] start --help`

به‌طور جایگزین، برای تمام گزینه‌های سرور به «All configuration» مراجعه کنید.

---

## قالب ارجاع به متغیرهای محیطی (Format for referencing environment variables)

می‌توانید برای resolve کردن یک مقدار وابسته به محیط از متغیرهای محیطی داخل فایل `keycloak.conf` با استفاده از نحوِ `${ENV_VAR}` استفاده کنید:

`db-url-host=${MY_DB_HOST}`

در صورتی که متغیر محیطی resolve نشود، می‌توانید یک مقدار جایگزین مشخص کنید. از `:` (کولون/دو نقطه) به شکل زیر پیش از `mydb` استفاده کنید:

`db-url-host=${MY_DB_HOST:mydb}`

---

## قالب برای گنجاندن یک فایل پیکربندی مشخص (Format to include a specific configuration file)

به‌طور پیش‌فرض، سرور همیشه گزینه‌های پیکربندی را از فایل `conf/keycloak.conf` می‌خواند. برای یک نصب جدید، این فایل تنها شامل تنظیمات comment‌شده است تا ایده‌ای از چیزهایی که می‌خواهید در حالت production تنظیم کنید ارائه دهد.

همچنین می‌توانید با استفاده از گزینه‌ی `[-cf|--config-file]` مسیر یک فایل پیکربندی صریح را مشخص کنید با وارد کردن دستور زیر:

`bin/kc.[sh|bat] --config-file=/path/to/myconfig.conf start`

تنظیم این گزینه باعث می‌شود Keycloak به‌جای `conf/keycloak.conf` از فایل مشخص‌شده پیکربندی را بخواند.

---

## تنظیم گزینه‌های حساس با استفاده از فایل Java KeyStore

به لطف «Keystore Configuration Source» می‌توانید مستقیماً خواص را از یک Java KeyStore با استفاده از گزینه‌های `[--config-keystore]` و `[--config-keystore-password]` بارگذاری کنید. به‌صورت اختیاری، می‌توانید نوع Keystore را با استفاده از گزینه‌ی `[--config-keystore-type]` مشخص کنید. به‌طور پیش‌فرض، نوع Keystore برابر `PKCS12` است.

اسرار در Keystore باید با الگوریتم کلید PBE (رمزنگاری مبتنی بر گذرواژه) ذخیره شوند، جایی که کلیدی از گذرواژه‌ی Keystore مشتق می‌شود. می‌توانید چنین Keystoreی را با دستور keytool زیر تولید کنید:

```
keytool -importpass -alias kc.db-password -keystore keystore.p12 -storepass keystorepass -storetype PKCS12 -v
```

پس از اجرای دستور، از شما خواسته می‌شود «Enter the password to be stored»، که نمایانگر مقدار ویژگی `kc.db-password` در بالا است.

وقتی Keystore ایجاد شد، می‌توانید سرور را با پارامترهای زیر راه‌اندازی کنید:

```
bin/kc.[sh|bat] start --config-keystore=/path/to/keystore.p12 --config-keystore-password=keystorepass --config-keystore-type=PKCS12
```

---

## قالب برای ویژگی‌های خام Quarkus (Format for raw Quarkus properties)

در اکثر موارد، گزینه‌های پیکربندیِ موجود برای پیکربندی سرور کافی هستند. با این حال، برای رفتار یا قابلیت خاصی که در پیکربندی Keycloak وجود ندارد، می‌توانید از ویژگی‌های فریم‌ورکِ زیرین یعنی Quarkus استفاده کنید.

تا حد ممکن از استفاده‌ی مستقیم از ویژگی‌های Quarkus خودداری کنید، زیرا توسط Keycloak پشتیبانی نمی‌شوند. اگر نیاز شما ضروری است، ابتدا در نظر بگیرید که یک درخواست بهبود (enhancement request) باز کنید. این رویکرد به ما کمک می‌کند تا پیکربندی Keycloak را برای انطباق بهتر با نیازهای شما بهبود دهیم.

اگر درخواست بهبود امکان‌پذیر نیست، می‌توانید سرور را با استفاده از ویژگی‌های خام Quarkus پیکربندی کنید:

* یک فایل `quarkus.properties` در دایرکتوری `conf` ایجاد کنید.

* ویژگی‌های موردنیاز را در آن فایل تعریف کنید.

می‌توانید تنها از یک زیرمجموعه از افزونه‌های Quarkus که در مستندات Quarkus تعریف شده‌اند استفاده کنید. همچنین، به تفاوت‌های زیر برای ویژگی‌های Quarkus توجه کنید:

* آیکون قفل برای یک ویژگی Quarkus در مستندات Quarkus نشان‌دهنده‌ی یک ویژگیِ زمان ساخت (build time property) است. برای اعمال این ویژگی باید دستور build را اجرا کنید. برای جزئیات درباره‌ی دستور build، به بخش‌های بعدی درباره‌ی بهینه‌سازی Keycloak مراجعه کنید.

* عدم وجود آیکون قفل برای یک ویژگی در راهنمای Quarkus نشان‌دهنده‌ی ویژگیِ زمان اجرا (runtime) برای Quarkus و Keycloak است.

همچنین می‌توانید ویژگی‌های Quarkus را در یک Java KeyStore ذخیره کنید.

توجه داشته باشید برخی ویژگی‌های Quarkus از قبل در پیکربندی Keycloak نگاشت شده‌اند، مانند `quarkus.http.port` و ویژگی‌های ضروری مشابه. اگر ویژگی توسط Keycloak استفاده شده باشد، تعریف آن کلید ویژگی در `quarkus.properties` بی‌اثر است. مقدار پیکربندی Keycloak بر مقدار ویژگی Quarkus تقدم دارد.

---

## استفاده از کاراکترهای خاص در مقادیر (Using special characters in values)

Keycloak برای پردازش مقادیر پیکربندی به Quarkus و MicroProfile وابسته است. توجه داشته باشید که expression valueها پشتیبانی می‌شوند. برای مثال، `${some_key}` به مقدار `some_key` ارزیابی می‌شود.

برای غیرفعال‌کردن ارزیابی expression، کاراکتر `\` به‌عنوان escape عمل می‌کند. به‌طور خاص، باید برای escape کردن استفاده از کاراکترهای `$` زمانی که به نظر می‌رسد برای تعریف یک expression استفاده شده‌اند یا تکرار شده‌اند، استفاده شود. برای مثال، اگر مقدار پیکربندی `my$$password` را می‌خواهید، از `my\$\$password` استفاده کنید. توجه داشته باشید کاراکتر `\` در بیشتر شِل‌های یونیکس یا وقتی در فایل‌های properties ظاهر می‌شود، نیازمند escape یا کوتیشن اضافی است. برای مثال، در bash کوتیشن تک‌گانه `--db-password='my\$\$password'` یک backslash تکی را حفظ می‌کند. همچنین، با کوتیشن دوتایی bash، به یک backslash اضافی نیاز دارید: `--db-password="my\\$\\$password"`. به‌طور مشابه در یک فایل properties، کاراکترهای backslash نیز باید escape شوند: `kc.db-password=my\\$\\$password`

---

## ملاحظات اختصاصی Windows (Windows-specific considerations)

هنگام مشخص‌کردن مسیرهای فایل Windows در مقادیر پیکربندی، backslashها نیز باید escape شوند. برای مثال، اگر می‌خواهید مسیر `C:\path\to\file` را مشخص کنید، باید آن را به صورت `C:\\path\\to\\file` بنویسید. به‌صورت جایگزین، می‌توانید از اسلش‌های رو به جلو که نیازی به escape ندارند استفاده کنید: `C:/path/to/file`.

هنگام استفاده از PowerShell و اگر مقادیر شما شامل کاراکترهای خاصی مانند کاما هستند، از کوتیشن تک‌گانه‌ی دورِ کوتیشن دوتایی استفاده کنید:

```
.\kc.bat start --log-level='"INFO,org.hibernate:debug"'
```

PowerShell کوتیشن‌ها را متفاوت مدیریت می‌کند. قبل از ارسال به اسکریپت `kc.bat` رشته‌ی کوتیشن‌گذاری‌شده را تفسیر کرده و کاراکترهای کوتیشن بیرونی را حذف می‌کند. بنابراین، برای حفظ ساختار مقدار، به یک لایه‌ی اضافی کوتیشن نیاز است. در غیر این صورت، کاما به‌عنوان delimiter تفسیر می‌شود. در CMD ویندوز، می‌توانید مستقیماً از کوتیشن دوتایی استفاده کنید.

---

## قالب‌ها برای کلیدهای متغیر محیطی با کاراکترهای خاص

کاراکترهای غیرالفانامریک در کلید پیکربندی شما باید به `_` در کلید متغیر محیطی متناظر تبدیل شوند.

متغیرهای محیطی با کوچک‌نویسی نام و جایگزینی `_` با `-` دوباره به کلید گزینه‌ها تبدیل می‌شوند. استثناء مربوط به wildcardهای logging است، زیرا `_` در دسته‌بندی logging با `.` جایگزین می‌شود. دسته‌های logging عموماً نام کلاس/بسته هستند که احتمال بیشتری دارد از `.` به‌جای `-` استفاده کنند.

### نگاشت خودکارِ کلید متغیر محیطی به کلید گزینه ممکن است کلیدِ موردنظر را حفظ نکند

برای مثال `kc.log-level-package.class_name` به کلید متغیر محیطی `KC_LOG_LEVEL_PACKAGE_CLASS_NAME` تبدیل می‌شود. این کلید به‌صورت خودکار به `kc.log-level-package.class.name` نگاشت می‌شود، زیرا `_` در دسته‌بندی logging با `.` جایگزین می‌شود. متأسفانه این با قصدِ `kc.log-level-package.class_name` منطبق نیست.

در این حالت چند گزینه دارید:

* در فایل `keycloak.conf` یک ورودی ایجاد کنید که به یک متغیر محیطی دلخواه شما ارجاع دهد. مثلاً `kc.log-level-package.class_name=${CLASS_NAME_LEVEL}`. درباره‌ی ارجاع به متغیرهای محیطی در بخش «Format for referencing environment variables» بیشتر ببینید.

* یا در موقعیت‌هایی که تغییر `keycloak.conf` ساده نیست، می‌توانید از یک جفت متغیر محیطی `KC_UNIQUEIFIER=value` و `KCKEY_UNIQUEIFIER=key` استفاده کنید، برای مثال `KC_MYKEY=debug` و `KCKEY_MYKEY=log-level-package.class_name`، یا `KC_LOG_LEVEL_PACKAGE_CLASS_NAME=debug` و `KCKEY_LOG_LEVEL_PACKAGE_CLASS_NAME=log-level-package.class_name`

---

## راه‌اندازی Keycloak (Starting Keycloak)

می‌توانید Keycloak را در حالت توسعه (development) یا تولید (production) راه‌اندازی کنید. هر حالت، پیش‌فرض‌های متفاوتی برای محیطِ موردنظر ارائه می‌دهد.

### راه‌اندازی Keycloak در حالت توسعه (Starting Keycloak in development mode)

از حالت توسعه برای امتحان اولیه‌ی Keycloak و بالا آوردن سریع آن استفاده کنید. این حالت پیش‌فرض‌های مناسبی برای توسعه‌دهندگان ارائه می‌دهد، مانند توسعه‌ی یک پوسته‌ی (theme) جدید برای Keycloak.

برای شروع در حالت توسعه، دستور زیر را وارد کنید:

`bin/kc.[sh|bat] start-dev`

#### پیش‌فرض‌ها (Defaults)

حالت توسعه تنظیمات پیش‌فرض زیر را اعمال می‌کند:

* HTTP فعال است

* strict hostname resolution غیرفعال است

* Cache روی حالت local تنظیم شده است (هیچ مکانیزم کشِ توزیع‌شده برای HA استفاده نمی‌شود)

* theme-caching و template-caching غیرفعال است

---

### راه‌اندازی Keycloak در حالت تولید (Starting Keycloak in production mode)

از حالت تولید برای استقرار Keycloak در محیط‌های production استفاده کنید. این حالت اصل «secure by default» را دنبال می‌کند.

برای شروع در حالت تولید، دستور زیر را وارد کنید:

`bin/kc.[sh|bat] start`

بدون پیکربندی بیشتر، این دستور Keycloak را راه‌اندازی نمی‌کند و به‌جای آن یک خطا به شما نشان می‌دهد. این رفتار عمدی است، زیرا Keycloak اصل «secure by default» را دنبال می‌کند. حالت تولید انتظار دارد هنگامی که راه‌اندازی می‌شود یک hostname تنظیم شده باشد و یک پیکربندی HTTPS/TLS در دسترس باشد.

#### پیش‌فرض‌ها (Defaults)

حالت تولید تنظیمات پیش‌فرض زیر را اعمال می‌کند:

* HTTP به‌عنوان لایه‌ی انتقال غیرفعال است (HTTPS ضروری است)

* پیکربندی hostname انتظار می‌رود

* پیکربندی HTTPS/TLS انتظار می‌رود

قبل از استقرار Keycloak در محیط production، مطمئن شوید مراحل مطرح‌شده در «Configuring Keycloak for production» را دنبال کرده‌اید.

به‌طور پیش‌فرض، گزینه‌های پیکربندی نمونه برای حالت production در فایل پیش‌فرض `conf/keycloak.conf` comment شده‌اند. این گزینه‌ها به شما ایده‌ای از پیکربندی‌های اصلی که هنگام اجرای Keycloak در production باید در نظر بگیرید، می‌دهند.

---

## ایجاد کاربر ادمین اولیه (Creating the initial admin user)

می‌توانید کاربر ادمین اولیه را با استفاده از رابط وب که از طریق اتصال محلی (localhost) قابل دسترسی است ایجاد کنید. در عوض، می‌توانید این کاربر را با استفاده از متغیرهای محیطی ایجاد کنید. `KC_BOOTSTRAP_ADMIN_USERNAME=<username>` را برای نام کاربری ادمین اولیه و `KC_BOOTSTRAP_ADMIN_PASSWORD=<password>` را برای گذرواژه ادمین اولیه تنظیم کنید.

Keycloak این مقادیر را در اولین راه‌اندازی parse می‌کند تا یک کاربر اولیه با حقوق ادمین ایجاد کند. وقتی اولین کاربر با حقوق ادمین وجود داشته باشد، می‌توانید از Admin Console یا ابزار خط فرمان `kcadm.[sh|bat]` برای ایجاد کاربران اضافی استفاده کنید.

اگر ادمین اولیه از قبل وجود داشته باشد و متغیرهای محیطی همچنان هنگام راه‌اندازی حاضر باشند، یک پیام خطا مبنی بر عدم موفقیت در ایجاد ادمین اولیه در لاگ‌ها نشان داده می‌شود. Keycloak این مقادیر را نادیده می‌گیرد و به‌درستی بالا می‌آید.

---

## بهینه‌سازی راه‌اندازی Keycloak (Optimize the Keycloak startup)

توصیه می‌کنیم قبل از استقرار Keycloak در محیط production، آن را برای ارائه‌ی راه‌اندازی سریع‌تر و مصرف حافظه‌ی بهتر بهینه کنید. این بخش توضیح می‌دهد چگونه بهینه‌سازی‌های Keycloak را برای بهترین عملکرد و رفتار زمان اجرا اعمال کنید.

### ایجاد یک build بهینه از Keycloak (Creating an optimized Keycloak build)

به‌طور پیش‌فرض، وقتی از دستور `start` یا `start-dev` استفاده می‌کنید، Keycloak برای راحتی، یک دستور build را در پس‌زمینه اجرا می‌کند.

این دستور build مجموعه‌ای از بهینه‌سازی‌ها را برای رفتارِ راه‌اندازی و زمان اجرا انجام می‌دهد. فرآیند build ممکن است چند ثانیه طول بکشد. به‌خصوص هنگام اجرای Keycloak در محیط‌های کانتینری مانند Kubernetes یا OpenShift، زمان راه‌اندازی مهم است. برای جلوگیری از از دست دادن آن زمان، اجرای build را پیش از راه‌اندازی و به‌صورت یک گام جداگانه (مثلاً در یک پایپ‌لاین CI/CD) انجام دهید.

#### گام اول: Build را به‌صورت صریح اجرا کنید (First step: Run a build explicitly)

برای اجرای build، دستور زیر را وارد کنید:

`bin/kc.[sh|bat] build <build-options>`

این دستور گزینه‌های buildی را که وارد می‌کنید نشان می‌دهد. Keycloak بین گزینه‌های build (که هنگام اجرای دستور build قابل استفاده‌اند) و گزینه‌های پیکربندی (که هنگام راه‌اندازی سرور قابل استفاده‌اند) تمایز قائل می‌شود.

برای یک راه‌اندازیِ غیرِ بهینه، این تمایز تأثیری ندارد. با این حال، اگر قبل از راه‌اندازی build را اجرا کنید، فقط یک زیرمجموعه از گزینه‌ها برای دستور build در دسترس است. این محدودیت به‌دلیل آن است که گزینه‌های build در یک تصویرِ بهینه‌شده‌ی Keycloak persist می‌شوند. برای مثال، پیکربندیِ credentialهایی مانند `db-password` (که یک گزینه‌ی پیکربندی است) نباید به‌دلایل امنیتی persist شوند.

تمام گزینه‌های build به‌صورت متن ساده ذخیره می‌شوند. هیچ داده‌ی حساسی را به‌عنوان گزینه‌های build ذخیره نکنید. این قاعده در تمام منابع پیکربندیِ موجود، شامل Keystore Config Source نیز صادق است. لذا توصیه نمی‌کنیم گزینه‌های build را در یک Java keystore ذخیره کنید. همچنین، وقتی صحبت از گزینه‌های پیکربندی است، توصیه می‌کنیم برای ذخیره‌ی داده‌های حساس در درجه‌ی اول از Keystore Config Source استفاده کنید. برای داده‌های غیرحساس می‌توانید از منابع دیگر استفاده کنید.
گزینه‌های build در «All configuration» با آیکون ابزار علامت‌گذاری شده‌اند. برای یافتن گزینه‌های build موجود، صفحه‌ی «All configuration» را با فیلتر گزینه‌های build ببینید یا دستور زیر را وارد کنید:

`bin/kc.[sh|bat] build --help`

مثال: اجرای build برای تنظیم پایگاه داده روی PostgreSQL پیش از راه‌اندازی
`bin/kc.[sh|bat] build --db=postgres`

---

#### گام دوم: راه‌اندازی Keycloak با استفاده از `--optimized` (Second step: Start Keycloak using --optimized)

پس از یک build موفق، می‌توانید Keycloak را راه‌اندازی کنید و رفتار پیش‌فرضِ راه‌اندازی را با وارد کردن دستور زیر خاموش کنید:

`bin/kc.[sh|bat] start --optimized <configuration-options>`

پارامتر `--optimized` به Keycloak می‌گوید فرض کند یک تصویرِ ازپیش‌ساخته و ازپیش‌بهینه‌شده‌ی Keycloak استفاده می‌شود. در نتیجه، Keycloak از بررسی و اجرای build مستقیماً در زمان راه‌اندازی صرف‌نظر می‌کند که باعث صرفه‌جویی در زمان می‌شود.

می‌توانید تمام گزینه‌های پیکربندی را هنگام راه‌اندازی وارد کنید؛ این گزینه‌ها همان‌هایی هستند که در «All configuration» با آیکون ابزار علامت‌گذاری نشده‌اند.

اگر یک گزینه‌ی build در زمان راه‌اندازی با مقداری برابرِ مقداری که هنگام build استفاده شده یافت شود، آن گزینه هنگام استفاده از `--optimized` به‌صورت بی‌صدا نادیده گرفته می‌شود.

اگر آن گزینه مقدار متفاوتی نسبت به مقداری که هنگام build استفاده شده داشته باشد، یک هشدار در لاگ‌ها ظاهر می‌شود و مقدارِ قبلاً ساخته‌شده استفاده می‌شود. برای اعمال این مقدار جدید، پیش از راه‌اندازی، یک build جدید اجرا کنید.

---

### ایجاد یک build بهینه (Create an optimized build)

مثال زیر ساخت یک build بهینه را نشان می‌دهد، به‌دنبال آن استفاده از پارامتر `--optimized` هنگام راه‌اندازی Keycloak.

تنظیم گزینه‌ی build برای vendor پایگاه داده PostgreSQL با استفاده از دستور build

`bin/kc.[sh|bat] build --db=postgres`

تنظیم گزینه‌های پیکربندی زمان اجرا (runtime) برای postgres در فایل `conf/keycloak.conf`.

```
db-url-host=keycloak-postgres
db-username=keycloak
db-password=change_me
hostname=mykeycloak.acme.com
https-certificate-file
```

راه‌اندازی سرور با پارامتر optimized

`bin/kc.[sh|bat] start --optimized`

می‌توانید بیشترِ بهینه‌سازی‌های مربوط به رفتارِ راه‌اندازی و زمان اجرا را با استفاده از دستور build به‌دست آورید. همچنین، با استفاده از فایل `keycloak.conf` به‌عنوان منبع پیکربندی، برخی گام‌ها را در زمان راه‌اندازی که در غیر این‌صورت به پارامترهای خط فرمان نیاز داشتند (مانند مقداردهی اولیه‌ی خود CLI)، حذف می‌کنید. در نتیجه، سرور حتی سریع‌تر راه‌اندازی می‌شود.

---

## استفاده از متغیرهای سیستم در پیکربندی Realm (Using system variables in the realm configuration)

برخی از قابلیت‌های realm به مدیران اجازه می‌دهند هنگام پیکربندی realm و اجزای آن به متغیرهای سیستم مانند متغیرهای محیطی و ویژگی‌های سیستم ارجاع دهند.

به‌طور پیش‌فرض، Keycloak استفاده از متغیرهای سیستم را مجاز نمی‌داند، مگر آن‌هایی که صراحتاً از طریق گزینه‌ی پیکربندی `spi-admin--allowed-system-variables` مشخص شده‌اند. این گزینه به شما اجازه می‌دهد یک فهرست جداشده با ویرگول از کلیدها را مشخص کنید که در نهایت به مقادیری از متغیرهای سیستم با همان کلید resolve می‌شوند.

سرور را راه‌اندازی کنید و مجموعه‌ای از متغیرهای سیستم را به زمان اجرای سرور در معرض قرار دهید

`bin/kc.[sh|bat] start --spi-admin--allowed-system-variables=FOO,BAR`

در انتشارهای آینده، این قابلیت به نفع جلوگیری از هرگونه استفاده از متغیرهای سیستم در پیکربندی realm حذف خواهد شد.

---

## مفاهیمِ زیرین (Underlying concepts)

این بخش نمای کلی از مفاهیم زیرین استفاده‌شده در Keycloak ارائه می‌دهد، به‌ویژه وقتی صحبت از بهینه‌سازیِ راه‌اندازی است.

Keycloak از فریم‌ورک Quarkus و رویکرد re-augmentation/mutable-jar در پس‌زمینه استفاده می‌کند. این فرآیند زمانی شروع می‌شود که دستور build اجرا شود.

موارد زیر برخی از بهینه‌سازی‌های انجام‌شده توسط دستور build هستند:

* یک فرض «دنیا-بسته» جدید درباره‌ی providerهای نصب‌شده ایجاد می‌شود، به این معنی که نیازی نیست در هر راه‌اندازی Keycloak رجیستری دوباره ایجاد و کارخانه‌ها مقداردهی اولیه شوند.

* فایل‌های پیکربندی از قبل parse می‌شوند تا I/O هنگام راه‌اندازی سرور کاهش یابد.

* منابع خاص پایگاه داده پیکربندی و برای اجرا در برابر vendor مشخصی از پایگاه داده آماده می‌شوند.

* با persist کردن گزینه‌های build در تصویر سرور، سرور هیچ گام اضافی برای تفسیر گزینه‌های پیکربندی و (باز)پیکربندی خودش انجام نمی‌دهد.



